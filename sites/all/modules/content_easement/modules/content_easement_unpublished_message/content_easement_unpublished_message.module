<?php

/**
 * Implements hook_content_easement_permission_alter().
 */
function content_easement_unpublished_message_content_easement_permission_alter(&$permissions) {
  $permissions['view unpublished message'] = array(
    'title' => t("View Unpublished Message"),
    'description' => t("Specify whether or not the unpublished message will be shown to some user or role."),
  );
}

/**
 * Implements hook_help().
 */
function content_easement_unpublished_message_help($path, $arg = NULL) {
  $function_history = array();
  cf_error_append_history($function_history, __FUNCTION__);

  if (function_exists('cf_version_exists')) {
    if (cf_is_empty_or_non_string('path', $path, WATCHDOG_ERROR)){
      return;
    }
  }
  else {
    if (cf_is_empty_or_non_string($function_history, 'path', $path, WATCHDOG_ERROR)){
      return;
    }
  }

  switch ($path) {
    case 'admin/help#content_easement_unpublished_message':
      $help = "Provides a simple message on the screen when a particular node the current user is viewing is unpublished.";
      $help .= " This helps make it more obvious to the user that a particular node is unpublished in a theme independent way.";
      $help .= " This is particular useful when combined with another module that allows users to view unpublished content that they do not own.";

      return "<p>" . t($help) . "</p>";
  }
}

/**
 * Implements hook_block_info().
 */
function content_easement_unpublished_message_block_info() {
  $blocks = array();

  $blocks['block'] = array(
    'info' => t("Unpublished Message"),
    'weight' => -99,
    'status' => 1,
    'region' => 'messages',
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function content_easement_unpublished_message_block_view($delta = '') {
  if (!user_access('view unpublished message')) return array();

  static $unpublished_messages = NULL;

  // show the message only once
  if (!is_null($unpublished_messages)){
    if (isset($unpublished_messages[$node->nid][$node->vid])){
      drupal_set_message("Called again!");
      return array();
    }
  }

  $node = menu_get_object();

  if (is_object($node) && property_exists($node, 'status') && $node->status == NODE_NOT_PUBLISHED){
    $node_type_name = check_plain(node_type_get_name($node));
    $node_title = isset($node->title) ? $node->title : '';

    if (empty($node_type_name)){
      $node_type_name = 'node';
    }

    $message = t("The !type '%title' is not published.", array('!type' => '<strong>' . $node_type_name . '</strong>', '%title' => $node_title));

    $block = array();
    $block['subject'] = NULL;
    $block['content'] = array(
      '#markup' => theme('container', array('element' => array('#children' => $message, '#attributes' => array('class' => 'content-easement-unpublished-message')))),
      '#attached' => array(
        'css' => array(drupal_get_path('module', 'content_easement_unpublished_message') . '/includes/message-unpublished.css'),
      ),
    );

    $unpublished_messages[$node->nid][$node->vid] = TRUE;
    return $block;
  }

  return array();
}
