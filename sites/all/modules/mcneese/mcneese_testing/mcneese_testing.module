<?php

/**
 * @file
 * McNeese State University Content Management module.
 */

/**
 * @defgroup mcneese_management Content Management
 * @{
 * Provides control panel interface functionality for drupal 7.
 */

/**
 * Implements hook_menu().
 */
function mcneese_testing_menu() {
  $items = array();

  $items['_ajax_/geoip'] = array(
    'title' => '',
    'page callback' => 'mcneese_testing_geoip',
    'access callback' => TRUE,
  );

  return $items;
}

/**
 * Gather and store geoip information.
 */
function mcneese_testing_geoip() {
  if (function_exists('devel_menu')) {
    $GLOBALS['devel_shutdown'] = FALSE;
  }

watchdog('debug', "DEBUG: _POST = " . print_r($_POST, TRUE));

  $data = array(
    'latitude' => '',
    'longitude' => '',
  );
  if (!empty($_POST["latitude"])) {
    $data['latitude'] = substr($_POST["latitude"], 96);
  }
  if (!empty($_POST["longitude"])) {
    $data['longitude'] = substr($_POST["longitude"], 96);
  }

  $fields = array();
  $fields['name'] = 'geoip';
  $fields['ip'] = '' . $_SERVER['REMOTE_ADDR'];
  $fields['agent'] = '' . $_SERVER['HTTP_USER_AGENT'];
  $fields['data'] = json_encode($data);

  try {
    $query = db_insert('testing');
    $query->fields($fields);

    $query->execute();
  }
  catch (Exception $e) {
    if (class_exists('cf_error')) {
      cf_error::on_query_execution($e);
    }
  }

  drupal_json_output(NULL);
}

/**
 * @} End of '@defgroup mcneese_management Content Management'.
 */
