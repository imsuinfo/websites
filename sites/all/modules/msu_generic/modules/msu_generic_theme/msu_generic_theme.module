<?php

/**
 * Returns an array of variables to be used by a given theme.
 *
 * @param variables
 *   The variables array from the theme template functions.
 *
 * @return
 *  An array of variables to be provided to the calling theme.
 */
function msu_generic_theme_get_variables(array &$variables){
  $msu = array();
  $msu['css'] = array();
  $msu['meta'] = array('charset' => 'UTF-8', 'content' => NULL, 'http-equiv' => array(), 'name' => array());
  $msu['agent'] = array('machine_name' => 'unknown', 'human_name' => 'unknown', 'major_version' => 'unknown', 'engine' => 'unknown', 'raw' => '');
  $msu['breadcrumb'] = array();
  $msu['markup_css'] = array('body' => array('id' => '', 'class' => ''), 'content' => array('id' => '', 'class' => ''));
  $msu['at'] = array('machine_name' => '', 'human_name' => '', 'url' => '', 'path' => '');
  $msu['theme'] = array('path' => '', 'machine_name' => '', 'human_name' => '');
  $msu['is'] = array();
  $msu['is_data'] = array();
  $msu['show'] = array();

  foreach (array('front', 'admin', 'using_database', 'node', 'emergency', 'maintenance', 'unsupported', 'debug', 'overlay') as $key){
    $msu['is'][$key] = FALSE;
    $msu['is_data'][$key] = array();
  }

  $msu['is_data']['unsupported'] = '';

  $user = cf_get_user();

  // set the request time if it exists
  if (!empty($_SERVER['REQUEST_TIME'])){
    $msu['request'] = $_SERVER['REQUEST_TIME'];
  }
  else {
    $msu['request'] = microtime();
  }

  // default to a 1-hour page expiration.
  $date_value = strtotime('+1 hours', $msu['request']);
  $msu['meta']['name']['expires'] = gmdate('D, d M Y H:i:s T', $date_value);

  // set the user agent
  if (function_exists('get_browser') && isset($_SERVER['HTTP_USER_AGENT'])){
    $browser_details = get_browser(null, true);

    $msu['agent']['raw'] = $_SERVER['HTTP_USER_AGENT'];

    if (!empty($msu['agent']['raw'])){
      // Gecko
      $matches = array();
      $result = preg_match('/ Gecko\b/i', $msu['agent']['raw'], $matches);
      if ($result > 0){
        $msu['agent']['engine'] = 'gecko';
      }

      // webkit
      $matches = array();
      $result = preg_match('/ AppleWebKit\b/i', $msu['agent']['raw'], $matches);
      if ($result > 0){
        $msu['agent']['engine'] = 'webkit';
      }
    }

    if (!empty($browser_details['browser'])){
      if ($browser_details['browser'] != 'Default Browser'){
        $msu['agent']['machine_name'] = strtolower($browser_details['browser']);
        $msu['agent']['human_name'] = $browser_details['browser'];
      }
    }

    if (!empty($browser_details['majorver'])){
      $msu['agent']['major_version'] = $browser_details['majorver'];
    }

    switch ($msu['agent']['machine_name']){
      case 'firefox':
        if ($msu['agent']['major_version'] < 3){
          $msu['is']['unsupported'] = TRUE;
        }
        $msu['agent']['human_name'] = 'Firefox';
        $msu['agent']['engine'] = 'gecko';
        break;
      case 'mozilla':
        // get the gecko api version and report unsupported for old mozilla apis
        if (!empty($agent_settings)){
          $matches = array();
          $result = preg_match('/rv:(\d*)\.(\d*)/i', $agent_settings, $matches);
          if ($result > 0){
            if (isset($matches[1]) && isset($matches[2])) {
              if ($matches[1] <= 1 && $matches[2] <= 7){
                $msu['is']['unsupported'] = TRUE;
              }
            }
          }
        }
        $msu['agent']['human_name'] = 'Mozilla';
        $msu['agent']['engine'] = 'gecko';
        break;
      case 'ie':
        if ($msu['agent']['major_version'] < 8){
          $msu['is']['unsupported'] = TRUE;
        }
        $msu['agent']['human_name'] = 'Internet Explorer';
        $msu['agent']['engine'] = 'trident';
        break;
      case 'opera':
        $msu['agent']['human_name'] = 'Opera';
        $msu['agent']['engine'] = 'presto';
        break;
      case 'chrome':
        $msu['agent']['human_name'] = 'Google Chrome';
        $msu['agent']['engine'] = 'webkit';
        break;
      default:
        if (!empty($msu['agent']['raw'])){
          // Midori
          $matches = array();
          $result = preg_match('/ Midori\b/i', $msu['agent']['raw'], $matches);
          if ($result > 0){
            $msu['agent']['machine_name'] = 'midori';
            $msu['agent']['human_name'] = 'Midori';
            $msu['agent']['engine'] = 'webkit';
          }
        }
        break;
    }
  }

  // set the default meta
  $msu['meta']['name']['copyright'] = '2011Â© McNeese State University';
  $msu['meta']['name']['description'] = 'McNeese State University Website';
  $msu['meta']['name']['distribution'] = 'web';
  $msu['meta']['name']['X-UA-Compatible'] = 'IE=8';

  // set frontpage defaults
  if (drupal_is_front_page() === TRUE) {
    $msu['is']['front'] = TRUE;
    $msu['meta']['name']['googlebot'] = 'noarchive,noindex';
    $msu['meta']['name']['robots'] = 'NOARCHIVE,NOINDEX,FOLLOW';
    $msu['meta']['name']['refresh'] = '43200'; // 12-hours
  }

  if (!empty($vars['is_admin'])){
    $msu['is']['admin'] = TRUE;
  }

  if (!empty($vars['logged_in'])){
    $msu['is']['logged_in'] = TRUE;
    $msu['is_data']['logged_in']['user'] = &$user;
  }

  if (!empty($vars['db_is_active'])){
    $msu['is']['using_database'] = TRUE;
    $msu['is_data']['using_database']['database'] = db_driver();
  }

  if (isset($vars['node']) && is_object($vars['node']) && isset($vars['node']->type)) {
    if (isset($vars['node']->nid) && !empty($vars['node']->nid)){
      $msu['is']['node'] = TRUE;
      $msu['is_data']['node']['node'] = &$vars['node'];
    }
  }

  if (module_exists('overlay')){
    $overlay_mode = overlay_get_mode();

    if ($overlay_mode == 'child'){
      $msu['is']['overlay'] = TRUE;
    }
  }

  // add url specific css
  global $base_url;
  global $base_dir;
  $msu['at']['machine_name'] = preg_replace('/^.*\/\//i', '', $base_url);
  $msu['at']['human_name'] = variable_get('site_name');
  $msu['at']['url'] = $base_url;
  $msu['at']['path'] = $base_dir;

  drupal_alter('msu_generic_theme_get_variables', $msu, $variables);

  // populate the body and content css tags
  foreach ($msu['is'] as $key => $value){
    if ($value === TRUE){
      $msu['markup_css']['body']['class'] .= ' is-' . $key;
      $msu['markup_css']['content']['class'] .= ' is-' . $key;
    }
  }

  $msu['at'] = preg_replace('/(\W)+/i', '_', $msu['at']);
  $msu['markup_css']['body']['class'] .= ' at-' . $msu['at'];
  $msu['markup_css']['content']['class'] .= ' at-' . $msu['at'];

  return $msu;
}

/**
 * Properly generates html headers depending on the contents of the $msu parameter.
 * This will auto-add all appropriate css headers through the appropriate drupal css calls.
 *
 * @param msu
 *   An array of header elements to process
 *
 * @return
 *   A string of html data
 */
function msu_generic_theme_generate_headers(array $msu){
  $output = '';

  // handle meta tags
  if (!empty($msu['meta']['charset'])){
    $output .= '<meta charset="' . filter_xss($msu['meta']['charset'], array()) . '">' . "\n";
  }

  $supported_meta = array();
  $supported_meta[] = 'abstract';
  $supported_meta[] = 'author';
  $supported_meta[] = 'classification';
  $supported_meta[] = 'copyright';
  $supported_meta[] = 'description';
  $supported_meta[] = 'distribution';
  $supported_meta[] = 'doc-class';
  $supported_meta[] = 'doc-rights';
  $supported_meta[] = 'doc-type';
  $supported_meta[] = 'DownloadOptions';
  $supported_meta[] = 'expires';
  $supported_meta[] = 'generator';
  $supported_meta[] = 'googlebot';
  $supported_meta[] = 'keywords';
  $supported_meta[] = 'MSSmartTagsPreventParsing';
  $supported_meta[] = 'name';
  $supported_meta[] = 'owner';
  $supported_meta[] = 'progid';
  $supported_meta[] = 'rating';
  $supported_meta[] = 'refresh';
  $supported_meta[] = 'reply-to';
  $supported_meta[] = 'resource-type';
  $supported_meta[] = 'revisit-after';
  $supported_meta[] = 'robots';
  $supported_meta[] = 'Template';
  $supported_meta[] = 'X-UA-Compatible'; // for specifying minimum Internet Explorer version

  foreach ($supported_meta as $tag){
    if (!empty($msu['meta']['name'][$tag])){
      $output .= '<meta name="' . $tag . '" content="' . filter_xss($msu['meta']['name'][$tag], array()) . '">' . "\n";
    }
  }

  // handle css (Currently not working)
  /*
  foreach ($msu['css'] as $key => &$css){
    if (!empty($css['data'])){
      drupal_add_css($css['data'], (!empty($css['options']) ? $css['options'] : NULL));
    }
  }
  */

  return $output;
}

/**
 * Safely render all variables specified in the $keys array.
 *
 * @param variables
 *   The variables array to process
 *
 * @param keys
 *   An array of key names to process
 *
* @param subdir (optional)
 *   A string representing a subdirectory inside of the variables parameter
 */
function msu_generic_theme_render_variables(&$variables, $keys, $subdir = NULL){
  if (is_null($subdir)){
    foreach ($keys as $key){
      if (empty($variables[$key])){
        $variables[$key] = '';
        $variables['msu']['show'][$key] = FALSE;
      }
      else {
        $variables[$key] = render($variables[$key]);
        $variables['msu']['show'][$key] = TRUE;
      }
    }
  } else {
    $variables['msu']['show'][$subdir] = array();

    foreach ($keys as $key){
      if (empty($variables[$subdir][$key])){
        $variables[$subdir][$key] = '';
        $variables['msu']['show'][$subdir][$key] = FALSE;
      }
      else {
        $variables[$subdir][$key] = render($variables[$subdir][$key]);
        $variables['msu']['show'][$subdir][$key] = TRUE;
      }
    }
  }
}
